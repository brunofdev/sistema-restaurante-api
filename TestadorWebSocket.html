<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurante V21 - Admin Day View</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        :root {
            --bg-client: #f4f6f8;
            --bg-admin: #2d3436;
            --text-admin: #dfe6e9;
            --primary: #0984e3;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: #1e272e; color: white; padding: 0 20px; height: 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); }
        .logo { font-weight: bold; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .ws-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #636e72; font-weight: bold; }
        .ws-badge.on { background: var(--success); color: #fff; }

        /* STATUS AUTH */
        .auth-status-bar { display: flex; gap: 15px; }
        .user-pill { font-size: 12px; padding: 4px 12px; border-radius: 20px; background: #2d3436; display: flex; align-items: center; gap: 6px; border: 1px solid #636e72; transition: 0.3s; }
        .user-pill.active { border-color: var(--success); color: var(--success); background: rgba(0, 184, 148, 0.1); }
        .indicator { width: 8px; height: 8px; border-radius: 50%; background: #636e72; }
        .active .indicator { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* LAYOUT PRINCIPAL */
        .container { display: flex; flex: 1; height: calc(100vh - 200px); }
        .pane-client { flex: 1; background: var(--bg-client); border-right: 2px solid #b2bec3; display: flex; flex-direction: column; padding: 15px; position: relative; overflow-y: auto; }
        .pane-admin { flex: 1; background: var(--bg-admin); color: var(--text-admin); display: flex; flex-direction: column; padding: 15px; position: relative; overflow-y: auto; }

        /* BLOCKER */
        .blocker { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.7); backdrop-filter: blur(4px); z-index: 10; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 10px; }
        .pane-admin .blocker { background: rgba(0,0,0,0.7); }
        .btn-login-zone { padding: 10px 25px; font-weight: bold; cursor: pointer; background: #2d3436; color: white; border: none; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-login-zone:hover { transform: scale(1.05); }

        /* CARDS */
        .card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #b2bec3; }
        .card-admin { background: #353b48; color: #f5f6fa; border-left: 4px solid var(--warning); margin-bottom: 8px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .status-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .item-list { font-size: 12px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 5px; margin-top: 5px; }
        .card-admin .item-list { border-top: 1px solid rgba(255,255,255,0.1); }
        .price-tag { font-weight: bold; font-size: 13px; color: var(--success); }

        /* CORES STATUS */
        .st-PENDENTE { background: #ffeaa7; color: #d35400; }
        .st-EM_PREPARACAO { background: #74b9ff; color: #0984e3; }
        .st-SAIU_PARA_ENTREGA { background: #a29bfe; color: #6c5ce7; }
        .st-ENTREGUE { background: #55efc4; color: #00b894; }
        .st-CANCELADO { background: #ff7675; color: #d63031; }

        /* SECTION HEADERS */
        .section-header { font-size: 12px; font-weight: bold; color: #7f8c8d; margin: 15px 0 5px 0; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 2px; }
        .admin-section { color: #b2bec3; border-color: #636e72; margin-top: 20px; }

        /* INPUTS & BOTOES */
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #b2bec3; border-radius: 4px; font-size: 13px; }
        .row { display: flex; gap: 10px; }
        button { cursor: pointer; border: none; padding: 10px; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        .btn-toggle { background: #b2bec3; color: white; font-size: 12px; padding: 8px; width: 100%; margin-top: 10px; }

        /* ADMIN ACTIONS */
        .actions-bar { display: flex; gap: 5px; margin-top: 10px; }
        .actions-bar button { flex: 1; font-size: 10px; color: white; opacity: 0.9; }
        .actions-bar button:hover { opacity: 1; transform: translateY(-1px); }

        /* LOG CONSOLE */
        #console { height: 150px; background: #111; color: #eee; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 11px; border-top: 4px solid #333; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .tag-error { background: #c0392b; color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; margin-right: 5px; }
        .error-type { color: #e74c3c; font-weight: bold; }
        .error-msg { color: #ff7675; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 400px; max-height: 90vh; overflow-y: auto; border-radius: 8px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }

        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #b2bec3; font-weight: bold; }
        .tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
    </style>
</head>
<body>

<div id="authModal" class="modal hidden">
    <div class="modal-box">
        <h3 id="modalTitle" style="text-align: center; margin-top: 0;">üîê Login</h3>
        <div class="tabs">
            <div class="tab active" onclick="setTab('login')">LOGIN</div>
            <div class="tab" onclick="setTab('cadastro')">CADASTRO</div>
        </div>
        <div id="viewLogin">
            <input type="text" id="loginUser" placeholder="CPF ou Username">
            <input type="password" id="loginPass" placeholder="Senha">
            <button class="btn-success" style="width: 100%; margin-top: 15px;" onclick="doLogin()">ENTRAR</button>
        </div>
        <div id="viewCadastro" class="hidden">
            <div style="text-align: right; margin-bottom: 5px;">
                <button class="btn-sm" style="background:#636e72; color:white" onclick="fillMock()">üé≤ Preencher</button>
            </div>
            <input type="text" id="cadNome" placeholder="Nome Completo">
            <input type="text" id="cadCpf" placeholder="CPF">
            <input type="email" id="cadEmail" placeholder="E-mail">
            <input type="text" id="cadTelefone" placeholder="Telefone">
            <input type="text" id="cadUser" placeholder="Username">
            <input type="password" id="cadPass" placeholder="Senha">
            <div id="fieldsCliente" class="hidden">
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0">
                <input type="text" id="cadCep" placeholder="CEP">
                <div class="row">
                    <input type="text" id="cadRua" placeholder="Rua" style="flex:2">
                    <input type="number" id="cadNumero" placeholder="N¬∫" style="flex:1">
                </div>
                <input type="text" id="cadComp" placeholder="Complemento">
                <div class="row">
                    <input type="text" id="cadBairro" placeholder="Bairro">
                    <input type="text" id="cadCidade" placeholder="Cidade">
                    <input type="text" id="cadEstado" placeholder="UF" maxlength="2" style="width: 60px;">
                </div>
            </div>
            <div id="fieldsOperador" class="hidden">
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0">
                <input type="number" id="cadMatricula" placeholder="Matr√≠cula">
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="doRegister()">CADASTRAR</button>
        </div>
        <button onclick="closeModal()" style="width: 100%; margin-top: 10px; background: transparent; color: #555;">Cancelar</button>
        <p id="errorMsg" style="color: red; font-size: 11px; text-align: center; margin-top: 10px;"></p>
    </div>
</div>

<header>
    <div class="logo">
        <span>üçΩÔ∏è V21 Day View</span>
        <span id="wsStatus" class="ws-badge">WS OFF</span>
    </div>
    <div class="auth-status-bar">
        <div id="statusClient" class="user-pill">
            <div class="indicator"></div> CLIENTE
        </div>
        <div id="statusAdmin" class="user-pill">
            <div class="indicator"></div> ADMIN
        </div>
    </div>
    <button class="btn-sm" onclick="logoutAll()" style="background: #c0392b; color: white;">SAIR GERAL</button>
</header>

<div class="container">

    <div class="pane-client">
        <div id="lockClient" class="blocker">
            <h3>√Årea Restrita</h3>
            <button class="btn-login-zone" onclick="openModal('CLIENTE')">üîê Entrar como Cliente</button>
        </div>
        <h2>üì± App do Cliente</h2>
        <div class="card" style="border-left: 4px solid var(--primary);">
            <b>Novo Pedido</b>
            <div class="row">
                <input type="number" id="prodId" placeholder="ID Produto" value="1">
                <input type="number" id="prodQtd" placeholder="Qtd" value="1">
            </div>
            <button class="btn-success" style="width:100%; margin-top:5px" onclick="fazerPedido()">ENVIAR PEDIDO</button>
        </div>
        <div class="section-header">üî• Pedidos em Andamento</div>
        <div id="listActive"></div>
        <button class="btn-toggle" onclick="toggleHistory()">üìú Mostrar Hist√≥rico</button>
        <div id="historyContainer" class="hidden" style="margin-top:10px; padding-top:10px; border-top:2px dashed #ccc;">
            <div class="section-header">‚úÖ Finalizados</div>
            <div id="listHistory"></div>
        </div>
    </div>

    <div class="pane-admin">
        <div id="lockAdmin" class="blocker">
            <h3>Cozinha Fechada</h3>
            <button class="btn-login-zone" onclick="openModal('OPERADOR')">üë®‚Äçüç≥ Entrar como Operador</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center">
            <h2>üë®‚Äçüç≥ Painel da Cozinha (Hoje)</h2>
            <button class="btn-sm" style="background:#555" onclick="loadAdminOrders()">üîÑ Sync</button>
        </div>

        <div class="section-header admin-section">üî• Fila de Preparo (Prioridade)</div>
        <div id="adminQueue"></div>

        <div class="section-header admin-section">‚úÖ Entregues / Finalizados</div>
        <div id="adminFinished"></div>
    </div>

</div>

<div id="console"></div>

<script>
    const API_URL = "http://localhost:8080";
    let stompClient = null;
    let clientToken = localStorage.getItem('clientToken');
    let adminToken = localStorage.getItem('adminToken');
    let activeRole = null;

    let subscribedOrders = new Set();

    window.onload = () => {
        refreshUI();
        connectWebSocket();
    };

    function refreshUI() {
        if (clientToken) {
            document.getElementById('lockClient').classList.add('hidden');
            document.getElementById('statusClient').classList.add('active');
        } else {
            document.getElementById('lockClient').classList.remove('hidden');
            document.getElementById('statusClient').classList.remove('active');
        }
        if (adminToken) {
            document.getElementById('lockAdmin').classList.add('hidden');
            document.getElementById('statusAdmin').classList.add('active');
        } else {
            document.getElementById('lockAdmin').classList.remove('hidden');
            document.getElementById('statusAdmin').classList.remove('active');
        }
    }

    function extractError(json) {
        if (json.erro && json.erro.message) return json.erro.message;
        if (json.erro && json.erro.errors && Array.isArray(json.erro.errors)) return json.erro.errors[0].defaultMessage;
        if (json.message) return json.message;
        return "Erro desconhecido";
    }

    function log(msg, isError = false) {
        const div = document.getElementById('console');
        const time = new Date().toLocaleTimeString();
        div.innerHTML = `<div class="log-line"><span class="log-time">[${time}]</span>${msg}</div>` + div.innerHTML;
    }

    function logError(json) {
        const div = document.getElementById('console');
        const time = new Date().toLocaleTimeString();
        const status = json.erro?.status || json.status || 500;
        const message = extractError(json);
        div.innerHTML = `<div class="log-line"><span class="tag-error">${status}</span> ${message}</div>` + div.innerHTML;
    }

    // === AUTH ===
    function openModal(role) {
        activeRole = role;
        document.getElementById('authModal').classList.remove('hidden');
        document.getElementById('modalTitle').innerText = role === 'CLIENTE' ? 'Login Cliente' : 'Login Operador';
        if (role === 'CLIENTE') {
            document.getElementById('fieldsCliente').classList.remove('hidden');
            document.getElementById('fieldsOperador').classList.add('hidden');
        } else {
            document.getElementById('fieldsCliente').classList.add('hidden');
            document.getElementById('fieldsOperador').classList.remove('hidden');
        }
        setTab('login');
    }
    function closeModal() { document.getElementById('authModal').classList.add('hidden'); }
    function setTab(mode) {
        document.getElementById('viewLogin').classList.toggle('hidden', mode !== 'login');
        document.getElementById('viewCadastro').classList.toggle('hidden', mode !== 'cadastro');
    }

    async function doLogin() {
        const user = document.getElementById('loginUser').value;
        const pass = document.getElementById('loginPass').value;
        const endpoint = activeRole === 'CLIENTE' ? '/api/auth/cliente-login' : '/api/auth/operador-login';
        try {
            const res = await fetch(API_URL + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cpf: user, userName: user, senha: pass })
            });
            const text = await res.text();
            let json;
            try { json = JSON.parse(text); } catch(e) { throw new Error(`Status ${res.status}`); }

            if (res.ok) {
                const token = json.dados?.token || json.token;
                if (activeRole === 'CLIENTE') {
                    clientToken = token;
                    localStorage.setItem('clientToken', token);
                } else {
                    adminToken = token;
                    localStorage.setItem('adminToken', token);
                }
                log(`<span style="color:#55efc4">‚úÖ ${activeRole} Logado!</span>`);
                closeModal();
                refreshUI();
                connectWebSocket();
            } else {
                document.getElementById('errorMsg').innerText = extractError(json);
                logError(json);
            }
        } catch (err) { log(`‚ùå Erro Login: ${err.message}`); }
    }

    async function doRegister() {
        const endpoint = activeRole === 'CLIENTE' ? '/cliente/cadastro' : '/operador/cadastro';
        const body = getRegisterBody();
        try {
            const res = await fetch(API_URL + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const json = await res.json();
            if (res.ok) {
                alert("Cadastro realizado!");
                setTab('login');
                document.getElementById('loginUser').value = body.userName;
                document.getElementById('loginPass').value = body.senha;
            } else {
                alert("Erro: " + extractError(json));
                logError(json);
            }
        } catch (err) { log(`‚ùå Erro: ${err.message}`); }
    }

    // === SYNC CLIENTE ===
    function isFinished(status) { return status === 'ENTREGUE' || status === 'CANCELADO'; }

    async function autoLoadActiveOrders() {
        if (!clientToken) return;
        log("üîÑ Sincronizando Cliente...");
        try {
            const res = await fetch(`${API_URL}/pedido/obter-pedidos-do-cliente?page=0&size=20&sort=id,desc`, {
                headers: { 'Authorization': `Bearer ${clientToken}` }
            });
            const json = await res.json();
            if (res.ok) {
                const pedidos = json.dados.content || [];
                document.getElementById('listActive').innerHTML = "";
                pedidos.forEach(p => {
                    if (!isFinished(p.statusPedido)) {
                        renderPedidoCliente(p);
                        subscribeToOrder(p.id);
                    }
                });
            }
        } catch (err) { log(`‚ùå Erro Load Cli: ${err.message}`); }
    }

    // === SYNC ADMIN (V21: PEDIDOS DO DIA) ===

    // Peso para ordena√ß√£o: Menor = Mais no topo
    function getSortWeight(status) {
        switch(status) {
            case 'PENDENTE': return 1;
            case 'EM_PREPARACAO': return 2;
            case 'SAIU_PARA_ENTREGA': return 3;
            case 'ENTREGUE': return 4;
            case 'CANCELADO': return 5;
            default: return 99;
        }
    }

    async function loadAdminOrders() {
        if (!adminToken) return;
        log("üë®‚Äçüç≥ Buscando pedidos do dia...");

        try {
            // Endpoint V21: obter-pedidos-do-dia
            const res = await fetch(`${API_URL}/pedido/obter-pedidos-do-dia?page=0&size=100`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const json = await res.json();

            if (res.ok) {
                const pedidos = json.dados.content || [];

                // Ordena√ß√£o Customizada no Frontend (JS)
                // 1. Pelo peso do status
                // 2. Se status igual, pelo ID decrescente (mais novo primeiro)
                pedidos.sort((a, b) => {
                    const weightA = getSortWeight(a.statusPedido);
                    const weightB = getSortWeight(b.statusPedido);
                    if(weightA !== weightB) return weightA - weightB;
                    return b.id - a.id;
                });

                // Limpa Listas
                document.getElementById('adminQueue').innerHTML = "";
                document.getElementById('adminFinished').innerHTML = "";

                pedidos.forEach(p => renderPedidoAdmin(p));
                log(`üë®‚Äçüç≥ Painel atualizado com ${pedidos.length} pedidos do dia.`);
            } else {
                logError(json);
            }
        } catch (err) { log(`‚ùå Erro Admin: ${err.message}`); }
    }

    async function toggleHistory() {
        const container = document.getElementById('historyContainer');
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            log("üìú Hist√≥rico...");
            try {
                const res = await fetch(`${API_URL}/pedido/obter-pedidos-do-cliente?page=0&size=20&sort=id,desc`, {
                    headers: { 'Authorization': `Bearer ${clientToken}` }
                });
                const json = await res.json();
                if (res.ok) {
                    const pedidos = json.dados.content || [];
                    const listHist = document.getElementById('listHistory');
                    listHist.innerHTML = "";
                    pedidos.forEach(p => {
                        if (isFinished(p.statusPedido)) renderPedidoCliente(p, true);
                    });
                }
            } catch (err) { log(`‚ùå Erro Hist: ${err.message}`); }
        } else { container.classList.add('hidden'); }
    }

    // === ACTIONS ===
    async function fazerPedido() {
        if (!clientToken) return alert("Sess√£o expirada.");
        const prodId = document.getElementById('prodId').value;
        const qtd = document.getElementById('prodQtd').value;
        try {
            const res = await fetch(`${API_URL}/pedido/criar-pedido`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` },
                body: JSON.stringify({ itens: [{ idProduto: parseInt(prodId), quantidade: parseInt(qtd) }] })
            });
            const json = await res.json();
            if (res.ok) {
                log(`üõí Pedido #${json.dados.id} criado!`);
                renderPedidoCliente(json.dados, false);
                subscribeToOrder(json.dados.id);
            } else {
                alert("Erro: " + extractError(json));
                logError(json);
            }
        } catch (err) { log(`‚ùå Erro: ${err.message}`); }
    }

    async function mudarStatus(id, novoStatus) {
        if (!adminToken) return alert("Apenas admin.");
        try {
            const res = await fetch(`${API_URL}/pedido/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                body: JSON.stringify({ statusPedido: novoStatus })
            });
            if (res.ok) {
                log(`‚úÖ Status alterado para ${novoStatus}`);
                // For√ßa reload para reordenar a lista conforme novos status
                setTimeout(loadAdminOrders, 500);
            } else {
                const json = await res.json();
                alert("Erro: " + extractError(json));
            }
        } catch (err) { log(`‚ùå Erro Status: ${err.message}`); }
    }

    // === RENDER ===
    function renderPedidoCliente(p, forceToHistory = false) {
        const status = p.statusPedido;
        const finished = isFinished(status);
        let targetListId = 'listActive';
        if (forceToHistory || finished) {
            targetListId = 'listHistory';
            const existingInActive = document.querySelector(`#listActive #cli-ped-${p.id}`);
            if (existingInActive) existingInActive.remove();
        }
        const list = document.getElementById(targetListId);
        if (targetListId === 'listHistory' && document.getElementById('historyContainer').classList.contains('hidden')) return;
        const existing = document.getElementById(`cli-ped-${p.id}`);
        if (existing) existing.remove();
        const itensTxt = p.itens.map(i => `${i.quantidade}x ${i.nomeProduto}`).join(', ');
        const html = `
            <div id="cli-ped-${p.id}" class="card">
                <div class="card-header">
                    <span><b>#${p.id}</b></span>
                    <span class="status-badge st-${status}">${status}</span>
                </div>
                <div class="item-list">${itensTxt}</div>
                <div style="text-align:right; margin-top:5px; font-weight:bold">R$ ${p.valorTotal.toFixed(2)}</div>
            </div>
        `;
        list.insertAdjacentHTML('afterbegin', html);
    }

    function renderPedidoAdmin(p) {
        const status = p.statusPedido;
        const finished = isFinished(status);

        // Define em qual lista o pedido deve ir (Fila ou Finalizados)
        const targetListId = finished ? 'adminFinished' : 'adminQueue';

        // Remove de qualquer lista antiga para mover visualmente
        const el1 = document.querySelector(`#adminQueue #adm-ped-${p.id}`);
        if(el1) el1.remove();
        const el2 = document.querySelector(`#adminFinished #adm-ped-${p.id}`);
        if(el2) el2.remove();

        const list = document.getElementById(targetListId);
        const itensHtml = p.itens.map(i => `<div>${i.quantidade}x ${i.nomeProduto} <span style="float:right">R$ ${i.subTotal.toFixed(2)}</span></div>`).join('');

        const html = `
            <div id="adm-ped-${p.id}" class="card card-admin" style="border-left: 4px solid ${finished ? '#2ecc71' : '#f1c40f'}">
                <div class="card-header">
                    <span><b>#${p.id}</b> - ${p.nomeUsuario}</span>
                    <span class="status-badge st-${status}">${status}</span>
                </div>
                <div class="item-list">${itensHtml}</div>
                <div class="actions-bar">
                    <button style="background:#3498db" onclick="mudarStatus(${p.id}, 'EM_PREPARACAO')">üî•</button>
                    <button style="background:#9b59b6" onclick="mudarStatus(${p.id}, 'SAIU_PARA_ENTREGA')">üõµ</button>
                    <button style="background:#2ecc71" onclick="mudarStatus(${p.id}, 'ENTREGUE')">‚úÖ</button>
                    <button style="background:#e74c3c" onclick="mudarStatus(${p.id}, 'CANCELADO')">‚ùå</button>
                </div>
            </div>
        `;
        // Append para respeitar a ordem do array ordenado
        list.insertAdjacentHTML('beforeend', html);
    }

    // === WEBSOCKET (V21) ===
    function connectWebSocket() {
        if (stompClient && stompClient.connected) return;
        if (!clientToken && !adminToken) return;

        const socket = new SockJS(`${API_URL}/ws`);
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, (frame) => {
            log(`<span style="color:#0984e3">üì° WS Conectado!</span>`);
            document.getElementById('wsStatus').classList.add('on');
            document.getElementById('wsStatus').innerText = "WS ON";

            if (adminToken) {
                stompClient.subscribe('/topico/admin-pedidos', (msg) => {
                    // Quando recebe evento real-time, recarrega para manter a ordem correta
                    loadAdminOrders();
                });
                loadAdminOrders();
            }

            if (clientToken) {
                autoLoadActiveOrders();
            }

        }, (err) => {
            document.getElementById('wsStatus').classList.remove('on');
            document.getElementById('wsStatus').innerText = "WS OFF";
            setTimeout(connectWebSocket, 5000);
        });
    }

    function subscribeToOrder(orderId) {
        if (!stompClient || !stompClient.connected) return;
        if (subscribedOrders.has(orderId)) return;
        stompClient.subscribe(`/topico/pedido/${orderId}`, (msg) => {
            const p = JSON.parse(msg.body);
            renderPedidoCliente(p);
            // Admin j√° atualiza pelo t√≥pico global
        });
        subscribedOrders.add(orderId);
    }

    // === UTILS ===
    function logoutAll() { localStorage.clear(); location.reload(); }
    function getRegisterBody() {
        const body = {
            nome: document.getElementById('cadNome').value,
            cpf: document.getElementById('cadCpf').value,
            email: document.getElementById('cadEmail').value,
            telefone: document.getElementById('cadTelefone').value,
            userName: document.getElementById('cadUser').value,
            senha: document.getElementById('cadPass').value
        };
        if (activeRole === 'CLIENTE') {
            body.cep = document.getElementById('cadCep').value;
            body.rua = document.getElementById('cadRua').value;
            body.numero = parseInt(document.getElementById('cadNumero').value) || 0;
            body.complemento = document.getElementById('cadComp').value;
            body.bairro = document.getElementById('cadBairro').value;
            body.cidade = document.getElementById('cadCidade').value;
            body.estado = document.getElementById('cadEstado').value;
        } else {
            body.matricula = parseInt(document.getElementById('cadMatricula').value) || 0;
        }
        return body;
    }
    function fillMock() {
        const r = Math.floor(Math.random() * 9000) + 1000;
        document.getElementById('cadNome').value = `User ${r}`;
        document.getElementById('cadCpf').value = Array(11).fill(0).map(()=>Math.floor(Math.random()*9)).join('');
        document.getElementById('cadEmail').value = `u${r}@t.com`;
        document.getElementById('cadTelefone').value = `119${r}1234`;
        document.getElementById('cadUser').value = `user${r}`;
        document.getElementById('cadPass').value = "Senha@123";
        if (activeRole === 'CLIENTE') {
            document.getElementById('cadCep').value = "01001000";
            document.getElementById('cadRua').value = "Rua Mock";
            document.getElementById('cadNumero').value = "10";
            document.getElementById('cadBairro').value = "Centro";
            document.getElementById('cadCidade').value = "SP";
            document.getElementById('cadEstado').value = "SP";
        } else {
            document.getElementById('cadMatricula').value = r;
        }
    }
</script>
</body>
</html>