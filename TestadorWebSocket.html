<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Restaurante V12 (Dual Token)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        :root {
            --bg-client: #f8f9fa;
            --bg-admin: #2c3e50;
            --text-admin: #ecf0f1;
            --green: #2ecc71;
            --red: #e74c3c;
            --blue: #3498db;
            --orange: #f39c12;
        }

        body { margin: 0; font-family: 'Segoe UI', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: #1a1a1a; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; height: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }

        .auth-status { display: flex; gap: 15px; font-size: 12px; }
        .status-pill { padding: 4px 10px; border-radius: 20px; background: #333; display: flex; align-items: center; gap: 5px; border: 1px solid #555; }
        .status-pill.active { border-color: var(--green); color: var(--green); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); }
        .active .dot { background: var(--green); box-shadow: 0 0 5px var(--green); }

        /* LAYOUT SPLIT */
        .main-container { display: flex; flex: 1; height: calc(100vh - 200px); }
        .pane-client { flex: 1; background: var(--bg-client); border-right: 4px solid #ccc; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; position: relative; }
        .pane-admin { flex: 1; background: var(--bg-admin); color: var(--text-admin); display: flex; flex-direction: column; padding: 10px; overflow-y: auto; position: relative; }

        /* BLOCKER (Quando n√£o logado) */
        .blocker { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.1); backdrop-filter: blur(2px); z-index: 5; display: flex; justify-content: center; align-items: center; }
        .btn-login-zone { padding: 10px 20px; font-size: 14px; cursor: pointer; background: #333; color: white; border: none; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* CARDS */
        .card { background: white; border-radius: 6px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: #333; }
        .card-dark { background: #34495e; color: white; border-left: 4px solid var(--orange); }

        /* INPUTS E BOTOES */
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin: 5px 0; width: 95%; box-sizing: border-box; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-green { background: var(--green); color: white; }
        .btn-blue { background: var(--blue); color: white; }

        /* ACTIONS ADMIN */
        .admin-actions { display: flex; gap: 5px; margin-top: 8px; }
        .btn-act { flex: 1; font-size: 10px; padding: 5px; color: white; border:none; border-radius:3px; cursor:pointer;}
        .act-prep { background: var(--blue); }
        .act-saiu { background: #9b59b6; }
        .act-fim { background: var(--green); }
        .act-cancel { background: var(--red); }

        /* CONSOLE */
        #console-log { height: 160px; background: #000; color: #0f0; font-family: monospace; padding: 10px; overflow-y: scroll; font-size: 11px; border-top: 3px solid #444; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .box { background: white; padding: 25px; border-radius: 8px; width: 340px; font-family: 'Segoe UI', sans-serif; max-height: 90vh; overflow-y: auto; }
        .hidden { display: none; }

        .tab-bar { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: bold; color: #777; }
        .tab.active { color: var(--blue); border-bottom: 2px solid var(--blue); }

        .st-tag { font-size:10px; padding:2px 5px; border-radius:3px; color:black; font-weight:bold; }
    </style>
</head>
<body>

<div id="authModal" class="modal hidden">
    <div class="box">
        <h3 id="modalTitle" style="margin-top:0">üîê Autentica√ß√£o</h3>
        <p id="modalDesc" style="font-size:12px; color:#666">Fa√ßa login para habilitar este painel.</p>

        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('login')">LOGIN</div>
            <div class="tab" onclick="switchTab('cadastro')">CADASTRO</div>
        </div>

        <div id="formLogin">
            <input type="text" id="logLogin" placeholder="CPF ou Username">
            <input type="password" id="logSenha" placeholder="Senha">
            <button id="btnLoginAction" class="btn-green" style="width:100%; margin-top:10px">ENTRAR</button>
        </div>

        <div id="formCadastro" class="hidden">
            <div style="display:flex; justify-content:flex-end; margin-bottom:5px">
                <button style="padding:2px 8px; font-size:10px; background:#777; color:white" onclick="preencherMock()">üé≤ Gerar Dados</button>
            </div>

            <input type="text" id="cadNome" placeholder="Nome Completo">
            <input type="text" id="cadCpf" placeholder="CPF (11 d√≠gitos)">
            <input type="email" id="cadEmail" placeholder="E-mail">
            <input type="text" id="cadTelefone" placeholder="Telefone (11) 9...">
            <input type="text" id="cadUser" placeholder="Username (Login)">
            <input type="password" id="cadSenha" placeholder="Senha">

            <div id="extraOperador" class="hidden">
                <input type="number" id="cadMatricula" placeholder="Matr√≠cula (ex: 1234)">
            </div>

            <div id="extraCliente" class="hidden">
                <input type="text" id="cadRua" placeholder="Rua">
                <div style="display:flex; gap:5px">
                    <input type="number" id="cadNumero" placeholder="N¬∫" style="width:30%">
                    <input type="text" id="cadComp" placeholder="Complemento" style="width:70%">
                </div>
                <div style="display:flex; gap:5px">
                    <input type="text" id="cadBairro" placeholder="Bairro">
                    <input type="text" id="cadCidade" placeholder="Cidade">
                </div>
                <div style="display:flex; gap:5px">
                    <input type="text" id="cadEstado" placeholder="UF" maxlength="2" style="width:30%">
                    <input type="text" id="cadCep" placeholder="CEP" style="width:70%">
                </div>
            </div>

            <button id="btnCadAction" class="btn-blue" style="width:100%; margin-top:10px">CADASTRAR</button>
        </div>

        <button onclick="closeModal()" style="width:100%; margin-top:10px; background:#ccc">Cancelar</button>
    </div>
</div>

<header>
    <div style="display:flex; align-items:center">
        <span>üöÄ <b>V12 Dual</b></span>
        <span id="wsStatus" class="badge off">WS: OFF</span>
    </div>

    <div class="auth-status">
        <div id="stClient" class="status-pill">
            <div class="dot"></div> üë§ Cliente
        </div>
        <div id="stAdmin" class="status-pill">
            <div class="dot"></div> üë®‚Äçüç≥ Admin
        </div>
    </div>

    <button class="btn-outline" onclick="logoutAll()">SAIR GERAL</button>
</header>

<div class="main-container">

    <div class="pane-client">
        <div class="pane-title" style="color:#333">üì± √Årea do Cliente</div>

        <div id="blockClient" class="blocker">
            <button class="btn-login-zone" onclick="openAuth('CLIENTE')">üîê Login Cliente</button>
        </div>

        <div class="card">
            <b>Novo Pedido</b>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="number" id="prodId" placeholder="ID Prod" value="1" style="flex:1">
                <input type="number" id="prodQtd" placeholder="Qtd" value="1" style="flex:1">
                <button class="btn-green" onclick="criarPedido()">Pedir</button>
            </div>
        </div>

        <div id="listaMeusPedidos"></div>
    </div>

    <div class="pane-admin">
        <div class="pane-title">üë®‚Äçüç≥ Cozinha</div>

        <div id="blockAdmin" class="blocker">
            <button class="btn-login-zone" onclick="openAuth('OPERADOR')">üîê Login Cozinha</button>
        </div>

        <div id="listaAdmin"></div>
    </div>
</div>

<div id="console-log">Logs de Sistema...</div>

<script>
    // CONFIG
    const API = 'http://localhost:8080';
    var stomp = null;

    // ESTADO GLOBAL (DOIS TOKENS)
    var clientToken = localStorage.getItem('clientToken');
    var adminToken = localStorage.getItem('adminToken');

    // VARI√ÅVEL DE CONTROLE DO MODAL
    var currentAuthType = ''; // 'CLIENTE' ou 'OPERADOR'

    // --- INICIALIZA√á√ÉO ---
    window.onload = () => {
        updateUI();
        conectarSocket(); // Tenta conectar WS se tiver pelo menos um token
    };

    function updateUI() {
        // Atualiza UI Cliente
        if(clientToken) {
            document.getElementById('blockClient').classList.add('hidden');
            document.getElementById('stClient').classList.add('active');
        } else {
            document.getElementById('blockClient').classList.remove('hidden');
            document.getElementById('stClient').classList.remove('active');
        }

        // Atualiza UI Admin
        if(adminToken) {
            document.getElementById('blockAdmin').classList.add('hidden');
            document.getElementById('stAdmin').classList.add('active');
        } else {
            document.getElementById('blockAdmin').classList.remove('hidden');
            document.getElementById('stAdmin').classList.remove('active');
        }
    }

    // --- CONTROLE DO MODAL ---
    function openAuth(type) {
        currentAuthType = type;
        document.getElementById('authModal').classList.remove('hidden');

        // Configura textos e campos baseados no tipo
        if(type === 'CLIENTE') {
            document.getElementById('modalTitle').innerText = "üîê Login Cliente";
            document.getElementById('extraCliente').classList.remove('hidden');
            document.getElementById('extraOperador').classList.add('hidden');
        } else {
            document.getElementById('modalTitle').innerText = "üîê Login Cozinha";
            document.getElementById('extraCliente').classList.add('hidden');
            document.getElementById('extraOperador').classList.remove('hidden');
        }

        // Configura os bot√µes para chamar a fun√ß√£o com o tipo certo
        document.getElementById('btnLoginAction').onclick = () => fazerLogin(type);
        document.getElementById('btnCadAction').onclick = () => fazerCadastro(type);

        switchTab('login'); // Sempre abre no login
    }

    function closeModal() {
        document.getElementById('authModal').classList.add('hidden');
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if(tab === 'login') {
            document.getElementById('formLogin').classList.remove('hidden');
            document.getElementById('formCadastro').classList.add('hidden');
        } else {
            document.getElementById('formLogin').classList.add('hidden');
            document.getElementById('formCadastro').classList.remove('hidden');
        }
    }

    // --- 1. LOGIN (DUAL) ---
    async function fazerLogin(type) {
        const login = document.getElementById('logLogin').value;
        const senha = document.getElementById('logSenha').value;

        try {
            // Endpoint unificado
            const res = await fetch(API + '/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cpf: login, senha: senha})
            });

            const json = await res.json();
            if(res.ok) {
                const token = json.dados.token;

                if(type === 'CLIENTE') {
                    clientToken = token;
                    localStorage.setItem('clientToken', token);
                    log("üë§ Cliente logado com sucesso");
                } else {
                    adminToken = token;
                    localStorage.setItem('adminToken', token);
                    log("üë®‚Äçüç≥ Admin logado com sucesso");
                }

                closeModal();
                updateUI();
                conectarSocket(); // Reconecta para garantir permiss√µes
            } else {
                alert("Erro: " + (json.message || "Login falhou"));
            }
        } catch(e) { log("Erro Login: " + e); }
    }

    // --- 2. CADASTRO (DUAL) ---
    async function fazerCadastro(type) {
        const endpoint = type === 'CLIENTE' ? '/cliente/cadastro' : '/operador/cadastro';

        // Base Comum
        const body = {
            nome: document.getElementById('cadNome').value,
            cpf: document.getElementById('cadCpf').value,
            email: document.getElementById('cadEmail').value,
            telefone: document.getElementById('cadTelefone').value,
            userName: document.getElementById('cadUser').value,
            senha: document.getElementById('cadSenha').value
        };

        // Espec√≠ficos
        if (type === 'CLIENTE') {
            body.rua = document.getElementById('cadRua').value;
            body.numero = parseInt(document.getElementById('cadNumero').value);
            body.complemento = document.getElementById('cadComp').value;
            body.bairro = document.getElementById('cadBairro').value;
            body.cidade = document.getElementById('cadCidade').value;
            body.estado = document.getElementById('cadEstado').value;
            body.cep = document.getElementById('cadCep').value;
        } else {
            body.matricula = parseInt(document.getElementById('cadMatricula').value);
        }

        log(`üì§ Cadastrando ${type}...`);

        try {
            const res = await fetch(API + endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            const json = await res.json();

            if(res.ok) {
                alert("‚úÖ Cadastro OK! Autenticando...");
                // Auto-login ap√≥s cadastro para facilitar
                document.getElementById('logLogin').value = body.userName;
                document.getElementById('logSenha').value = body.senha;
                switchTab('login');
            } else {
                alert("Erro Cadastro:\n" + (json.dados?.message || json.message));
            }
        } catch(e) { log("Erro Fetch: " + e); }
    }

    // --- 3. A√á√ïES CLIENTE (Usa clientToken) ---
    async function criarPedido() {
        if(!clientToken) return alert("Logue como cliente primeiro!");

        const prod = document.getElementById('prodId').value;
        const qtd = document.getElementById('prodQtd').value;

        try {
            const res = await fetch(`${API}/pedido/criar-pedido`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + clientToken },
                body: JSON.stringify({itens: [{ idProduto: prod, quantidade: qtd }], observacao: "Dual Test"})
            });

            const json = await res.json();
            if(res.ok) {
                log("üë§ [CLIENTE] Pedido Criado #" + json.dados.id);
                renderClienteItem(json.dados);
                // Escuta atualiza√ß√µes deste pedido espec√≠fico
                stomp.subscribe('/topico/pedido/' + json.dados.id, (msg) => {
                    const p = JSON.parse(msg.body);
                    renderClienteItem(p);
                    renderAdminItem(p);
                });
            } else {
                alert("Erro ao criar: " + json.message);
            }
        } catch(e) { log("Erro criarPedido: " + e); }
    }

    // --- 4. A√á√ïES ADMIN (Usa adminToken) ---
    async function mudarStatus(id, status) {
        if(!adminToken) return alert("Logue como Cozinha primeiro!");

        try {
            const res = await fetch(`${API}/pedido/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + adminToken },
                body: JSON.stringify({ statusPedido: status })
            });

            if(res.ok) {
                log(`üëÆ [ADMIN] Status #${id} -> ${status}`);
            } else {
                const json = await res.json();
                alert("Erro Admin: " + json.message);
            }
        } catch(e) { log("Erro Status: " + e); }
    }

    // --- 5. WEBSOCKET (Usa Token Admin preferencialmente) ---
    function conectarSocket() {
        if(stomp && stomp.connected) return;

        // Tenta usar token de admin para conectar, sen√£o usa de cliente, sen√£o sem token
        // Nota: Se seu WS exigir autentica√ß√£o, passe o token no connect headers
        var socket = new SockJS(`${API}/ws`);
        stomp = Stomp.over(socket);
        stomp.debug = () => {};

        stomp.connect({}, () => {
            log("üì° WS Conectado");
            document.getElementById('wsStatus').innerText = "ON";
            document.getElementById('wsStatus').className = "badge on";

            // Se tiver token de admin, inscreve no t√≥pico geral
            if(adminToken) {
                stomp.subscribe('/topico/admin-pedidos', (msg) => {
                    log("üîî [WS-Admin] Novo Pedido!");
                    renderAdminItem(JSON.parse(msg.body));
                });
            }

        }, (err) => log("‚ùå WS Off: " + err));
    }

    // --- RENDERS E UTILS ---
    function renderClienteItem(p) {
        const container = document.getElementById('listaMeusPedidos');
        let el = document.getElementById('cli-' + p.id);
        if(!el) {
            el = document.createElement('div');
            el.id = 'cli-' + p.id;
            el.className = 'card';
            container.prepend(el);
        }
        const st = p.status || p.statusPedido;
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between"><b>#${p.id}</b> <span class="st-tag" style="background:#eee">${st}</span></div>
            <div style="font-size:12px">Total: R$ ${p.valorTotal}</div>
        `;
        if(st === 'ENTREGUE') el.style.borderLeft = '4px solid green';
    }

    function renderAdminItem(p) {
        if(!adminToken) return; // S√≥ renderiza se for admin
        const container = document.getElementById('listaAdmin');
        let el = document.getElementById('adm-' + p.id);
        if(!el) {
            el = document.createElement('div');
            el.id = 'adm-' + p.id;
            el.className = 'card card-dark';
            container.prepend(el);
        }
        const st = p.status || p.statusPedido;
        el.innerHTML = `
            <div style="display:flex; justify-content:space-between"><b>#${p.id}</b> <span style="color:#f39c12">${st}</span></div>
            <div style="font-size:11px; margin:5px 0">${p.itens ? p.itens.map(i => i.quantidade + 'x ' + i.nomeProduto).join(', ') : '...'}</div>
            <div class="admin-actions">
                <button class="btn-act act-prep" onclick="mudarStatus(${p.id}, 'EM_PREPARACAO')">üî•</button>
                <button class="btn-act act-saiu" onclick="mudarStatus(${p.id}, 'SAIU_PARA_ENTREGA')">üõµ</button>
                <button class="btn-act act-fim" onclick="mudarStatus(${p.id}, 'ENTREGUE')">‚úÖ</button>
                <button class="btn-act act-cancel" onclick="mudarStatus(${p.id}, 'CANCELADO')">‚ùå</button>
            </div>
        `;
    }

    function logoutAll() { localStorage.clear(); location.reload(); }

    function preencherMock() {
        const r = Math.floor(Math.random() * 9000);
        document.getElementById('cadNome').value = `User ${r}`;
        document.getElementById('cadCpf').value = gerarCpf();
        document.getElementById('cadEmail').value = `u${r}@test.com`;
        document.getElementById('cadTelefone').value = `119${r}1234`;
        document.getElementById('cadUser').value = `user${r}`;
        document.getElementById('cadSenha').value = "Senha@123";

        if(currentAuthType === 'CLIENTE') {
            document.getElementById('cadRua').value = "Rua Teste";
            document.getElementById('cadNumero').value = "100";
            document.getElementById('cadComp').value = "Ap 1";
            document.getElementById('cadBairro').value = "Centro";
            document.getElementById('cadCidade').value = "SP";
            document.getElementById('cadEstado').value = "SP";
            document.getElementById('cadCep').value = "01000-000";
        } else {
            document.getElementById('cadMatricula').value = r;
        }
    }

    function gerarCpf() { let c = ""; for(let i=0; i<11; i++) c+=Math.floor(Math.random()*9); return c; }
    function log(msg) { const d = document.getElementById('console-log'); d.innerHTML += `<div>> ${msg}</div>`; d.scrollTop = d.scrollHeight; }

</script>
</body>
</html>