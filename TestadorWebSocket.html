<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Restaurante V9 (Full Status)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        :root { --bg: #f0f2f5; --white: #fff; --dark: #2c3e50; --green: #4CAF50; --red: #f44336; --blue: #2196F3; --orange: #ff9800; --purple: #9c27b0; }
        body { margin: 0; font-family: monospace; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }

        header { background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 4px; margin-left:10px;}
        .on { background: var(--green); } .off { background: var(--red); }

        .container { display: flex; flex: 1; height: 100%; font-family: 'Segoe UI', sans-serif; }
        .panel { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .panel-left { background: var(--white); border-right: 2px solid #ddd; }
        .panel-right { background: var(--dark); color: #ecf0f1; }

        .card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-dark { background: #34495e; border: none; border-left: 5px solid #f1c40f; color: white; }

        #console-log { height: 150px; background: #000; color: #0f0; font-family: monospace; padding: 10px; overflow-y: scroll; font-size: 12px; border-top: 2px solid #555; }

        .role-badge { background: #ff9800; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; margin-left: 5px; }

        /* Modal Login */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .box { background: white; padding: 30px; border-radius: 8px; width: 300px; text-align: center; font-family: 'Segoe UI', sans-serif; }
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-green { background: var(--green); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .hidden { display: none; }

        .row { display: flex; gap: 10px; flex-wrap: wrap; }
        .status-big { font-size: 24px; font-weight: bold; margin: 10px 0; }

        /* Bot√µes de A√ß√£o Admin */
        .btn-action { padding: 6px; cursor: pointer; border: none; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; flex: 1; }
        .act-prep { background: var(--blue); }
        .act-saiu { background: var(--purple); }
        .act-fim { background: var(--green); }
        .act-cancel { background: var(--red); }
        .act-reset { background: #7f8c8d; } /* Cinza para testar erros */

        /* Cores Status */
        .bg-PENDENTE { background: #fff3cd; }
        .bg-EM_PREPARACAO { background: #cce5ff; }
        .bg-SAIU_PARA_ENTREGA { background: #d1ecf1; }
        .bg-ENTREGUE { background: #d1e7dd; }
        .bg-CANCELADO { background: #f8d7da; }
    </style>
</head>
<body>

<div id="loginModal" class="modal">
    <div class="box">
        <h2>üîê Login Admin</h2>
        <input type="text" id="loginCpf" placeholder="CPF">
        <input type="password" id="loginSenha" placeholder="Senha">
        <button class="btn-green" style="width:100%" onclick="fazerLogin()">ENTRAR</button>
        <p id="loginMsg" style="color:red; font-size:12px;"></p>
    </div>
</div>

<header>
    <div>
        <b>Dashboard V9</b>
        <span id="wsStatus" class="badge off">WS: OFFLINE</span>
    </div>
    <div>
        <span id="userDisplay">--</span>
        <span id="roleDisplay" class="role-badge" style="display:none">--</span>
        <button onclick="resetarTudo()" style="font-size:10px; margin-left:10px; color:black">SAIR</button>
        <button class="btn-blue" style="font-size:10px;" onclick="conectarSocket()">RECONECTAR</button>
    </div>
</header>

<div class="container">
    <div class="panel panel-left">
        <h3>üì± Cliente</h3>
        <div class="card">
            <div class="row">
                <input type="number" id="idProd" placeholder="ID Prod" value="1" style="width:50px">
                <input type="number" id="qtdProd" placeholder="Qtd" value="1" style="width:50px">
                <button class="btn-green" onclick="criarPedido()">Pedir</button>
            </div>
        </div>
        <div id="monitorCliente" class="card" style="display:none; text-align: center;">
            <small>Pedido #<span id="cliId">0</span></small>
            <div id="cliStatus" class="status-big">--</div>
            <div>R$ <span id="cliTotal">0.00</span></div>
        </div>
    </div>

    <div class="panel panel-right">
        <h3>üë®‚Äçüç≥ Cozinha</h3>
        <div id="listaAdmin"></div>
    </div>
</div>

<div id="console-log">Logs de Depura√ß√£o...</div>

<script>
    const API = 'http://localhost:8080';
    var stomp = null;
    var token = localStorage.getItem('token');

    function log(msg) {
        const div = document.getElementById('console-log');
        div.innerHTML += `<div>> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
        console.log(msg);
    }

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) { return null; }
    }

    function updateUserInfo() {
        if(token) {
            const payload = parseJwt(token);
            if(payload) {
                const user = payload.sub || "Usuario";
                const role = payload.role || payload.roles || payload.authorities || "???";
                document.getElementById('userDisplay').innerText = user;
                document.getElementById('roleDisplay').innerText = role;
                document.getElementById('roleDisplay').style.display = 'inline-block';
                log(`üîç TOKEN: User=${user} | Role=${role}`);
            }
        }
    }

    window.onload = () => {
        if(token) {
            document.getElementById('loginModal').classList.add('hidden');
            updateUserInfo();
            setTimeout(conectarSocket, 500);
        }
    };

    function resetarTudo() { localStorage.clear(); location.reload(); }

    // === 1. LOGIN ===
    async function fazerLogin() {
        const cpf = document.getElementById('loginCpf').value;
        const senha = document.getElementById('loginSenha').value;

        try {
            const res = await fetch(`${API}/api/auth/cliente-login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cpf, senha})
            });
            const json = await res.json();

            if(res.ok) {
                token = json.dados.token;
                localStorage.setItem('token', token);
                document.getElementById('loginModal').classList.add('hidden');
                updateUserInfo();
                conectarSocket();
            } else {
                document.getElementById('loginMsg').innerText = json.message;
            }
        } catch(e) { log("Erro Login: " + e); }
    }

    // === 2. WEBSOCKET ===
    function conectarSocket() {
        if(stomp && stomp.connected) return;
        log("Conectando WS (P√∫blico)...");
        var socket = new SockJS(`${API}/ws`);
        stomp = Stomp.over(socket);
        stomp.debug = () => {};

        stomp.connect({}, (frame) => {
            log("‚úÖ WebSocket Conectado!");
            document.getElementById('wsStatus').innerText = "WS: ONLINE";
            document.getElementById('wsStatus').className = "badge on";

            stomp.subscribe('/topico/admin-pedidos', (msg) => {
                log("üîî NOTIFICA√á√ÉO ADMIN RECEBIDA!");
                renderAdmin(JSON.parse(msg.body));
            });

        }, (err) => {
            log("‚ùå Erro WebSocket: " + err);
            document.getElementById('wsStatus').innerText = "WS: ERRO";
            document.getElementById('wsStatus').className = "badge off";
        });
    }

    // === 3. CLIENTE ===
    async function criarPedido() {
        const idProd = document.getElementById('idProd').value;
        const qtd = document.getElementById('qtdProd').value;

        try {
            const res = await fetch(`${API}/pedido/criar-pedido`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({itens: [{ idProduto: idProd, quantidade: qtd }], observacao: "Teste V9"})
            });
            const json = await res.json();
            if(res.ok) {
                log("‚úÖ Pedido Criado ID: " + json.dados.id);
                acompanhar(json.dados);
            } else {
                log("‚ùå Erro Criar: " + json.message);
                alert("Erro ao criar: " + json.message);
            }
        } catch(e) { log("Erro Fetch Criar: " + e); }
    }

    function acompanhar(pedido) {
        updateClientUI(pedido);
        document.getElementById('monitorCliente').style.display = 'block';
        stomp.subscribe('/topico/pedido/' + pedido.id, (msg) => {
            log("üîî CLIENTE: Atualiza√ß√£o recebida!");
            updateClientUI(JSON.parse(msg.body));
        });
    }

    function updateClientUI(p) {
        const st = p.status || p.statusPedido;
        document.getElementById('cliId').innerText = p.id;
        document.getElementById('cliStatus').innerText = st;
        const total = typeof p.valorTotal === 'number' ? p.valorTotal.toFixed(2) : p.valorTotal;
        document.getElementById('cliTotal').innerText = total;

        const box = document.getElementById('monitorCliente');
        box.className = "card " + "bg-" + st;
    }

    // === 4. ADMIN ===
    function renderAdmin(p) {
        const lista = document.getElementById('listaAdmin');
        const existe = document.getElementById('adm-' + p.id);
        if(existe) existe.remove();

        const st = p.status || p.statusPedido;
        const div = document.createElement('div');
        div.id = 'adm-' + p.id;
        div.className = "card card-dark";

        // LISTA COMPLETA DE BOT√ïES PARA TODOS OS STATUS
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between">
                <b>#${p.id} - ${p.nomeUsuario || 'Cliente'}</b>
                <span style="color:#f1c40f">${st}</span>
            </div>
            <div style="margin:10px 0; font-size:12px">
                ${p.itens ? p.itens.map(i => i.quantidade + 'x ' + i.nomeProduto).join(', ') : ''}
            </div>

            <div class="row" style="margin-top:10px">
                <button class="btn-action act-reset" onclick="mudarStatus(${p.id}, 'PENDENTE')">‚Ü©Ô∏è Reset</button>
                <button class="btn-action act-prep" onclick="mudarStatus(${p.id}, 'EM_PREPARACAO')">üî• Preparar</button>
                <button class="btn-action act-saiu" onclick="mudarStatus(${p.id}, 'SAIU_PARA_ENTREGA')">üõµ Enviar</button>
            </div>
            <div class="row" style="margin-top:5px">
                <button class="btn-action act-fim" onclick="mudarStatus(${p.id}, 'ENTREGUE')">‚úÖ Entregue</button>
                <button class="btn-action act-cancel" onclick="mudarStatus(${p.id}, 'CANCELADO')">‚ùå Cancelar</button>
            </div>
        `;
        lista.prepend(div);
    }

    async function mudarStatus(id, status) {
        log(`üõ†Ô∏è ADMIN: Mudando #${id} para ${status}...`);

        const res = await fetch(`${API}/pedido/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ statusPedido: status })
        });

        if(!res.ok) {
            // Tenta pegar a mensagem de erro do Spring
            const json = await res.json();
            const erroMsg = json.message || json.error || res.statusText;

            log(`‚ùå ERRO (Status ${res.status}): ${erroMsg}`);
            alert("‚õî ERRO DE REGRA DE NEG√ìCIO:\n\n" + erroMsg);
        } else {
            log("‚úÖ PATCH enviado com sucesso!");
        }
    }
</script>
</body>
</html>